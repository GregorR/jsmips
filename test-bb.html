<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="xterm.css"></script>
        <script type="text/javascript" src="nomath.js"></script>
        <script type="text/javascript" src="vmem.js"></script>
        <script type="text/javascript" src="consts.js"></script>
        <script type="text/javascript" src="mips.js"></script>
        <script type="text/javascript" src="fs/fs.js"></script>
        <script type="text/javascript" src="xterm.js"></script>
        <script type="text/javascript" src="xtermtty.js"></script>
    </head>
    <body>
        <script type="text/javascript">(function() {
            // Make the terminal
            var termBox = document.createElement("div");
            document.body.appendChild(termBox);
            var term = new Terminal();
            term.open(termBox);

            // Our filesystem is remote
            JSMIPS.XHRFS.mount("http://localhost:8000/root/usr/", "/usr/");

            // Get busybox
            var ub = JSMIPS.XHRFS.assert("/usr/bin/busybox");
            if (ub) ub.unblock = go;
            else go();

            function go() {
                // Install busybox
                ["/bin", "/sbin", "/usr/sbin"].forEach(function(d) {
                    JSMIPS.FS.mkdir(d);
                });
                var m = new JSMIPS.MIPS();
                m.execve("/usr/bin/busybox", ["/usr/bin/busybox", "--install", "-s"]);
                m.xterm(term);
                m.onstop.push(goa2);
                m.run();
            }

            function goa2() {
                //var ub = JSMIPS.XHRFS.assert("/usr/libexec/gcc/mips-linux-musl/9.2.0/cc1");
                var ub = JSMIPS.XHRFS.assert("/usr/lib/libc.so");
                if (ub) ub.unblock = go2;
                else go2();
            }

            function go2() {
                // Run a shell
                var m = new JSMIPS.MIPS();
                //m.debug = JSMIPS.DEBUG_SYSCALLS;
                //m.execve("/bin/sh", ["/bin/sh", "-i"], ["PATH=/bin:/usr/bin"]);
                m.execve("/usr/lib/libc.so", ["/usr/lib/libc.so", "/usr/bin/a.out"], ["PATH=/bin:/usr/bin"]);
                //m.execve("/usr/libexec/gcc/mips-linux-musl/9.2.0/cc1", ["/usr/libexec/gcc/mips-linux-musl/9.2.0/cc1","-quiet","usr/test.c","-meb","-quiet","-dumpbase","test.c","-march=mips1","-msoft-float","-mllsc","-mips1","-mabi=32","-auxbase","test","-o","/tmp/ccFdmaid.s"], ["SHLVL=1","PATH=/bin:/usr/bin","PWD=","COLLECT_GCC=gcc","COLLECT_LTO_WRAPPER=/usr/libexec/gcc/mips-linux-musl/9.2.0/lto-wrapper","COLLECT_GCC_OPTIONS='-march=mips1' '-msoft-float' '-mllsc' '-mips1' '-EB' '-mabi=32'"]);
                m.xterm(term);
                m.run();
            }
        })();
        </script>
    </body>
</html>
